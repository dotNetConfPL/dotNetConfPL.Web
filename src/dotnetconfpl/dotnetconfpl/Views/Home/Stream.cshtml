@model dotnetconfpl.Controllers.StreamModel

@{
    ViewBag.Title = "dotnetconf.pl";
}

@* 1. Enable password, generate new hash
   3. Create new Admin panel
   4. Try adding voting system, get event store 
      - display 3 cards red, yellow, green + edit box with comment
      - add validation for comment around 250 chars *@

@{
    var url = @Model.CurrentStream;
}

<section id="news">
    <div class="container text-center">
        <div id="inject-place">
            <label id="stream-title">@Html.Raw(Model.CurrentStreamInfo)</label>
            <iframe width="420" height="315" src="@url" frameborder="0" allowfullscreen></iframe>
        </div>
        <div>
            <p class="last-chance-text">
                Stream odświeża się automatycznie, w razie awarii
                <a style="font-size: 10px;" id="ForceRefresh" href="@Url.Action("Stream")">Odświeżenie ostatniej szansy :)</a>
            </p>
        </div>

        @* TODO STYLING AROUND HERE *@
        <input id="vote-comment"/>
        <span class="vote-div" id="green" style="background-color: green">Green</span>
        <span class="vote-div" id="yellow" style="background-color: yellow">Yellow</span>
        <span class="vote-div" id="red" style="background-color: red">Red</span>
    </div>
</section>

@if (Model.IsAdmin)
{
    <label>Stream Url</label>
    <input id="new-stream" />
    <br/>
    <label>Password</label> 
    <input id="password" />
    <br/>
    <select id="selected-stream">
        <option value="brak">brak</option>
        <option value="maniserowicz">maniserowicz</option>
        <option value="filipwoj">filipwoj</option>
        <option value="basiafusinska">basiafusinska</option>
        <option value="gutek">gutek</option>
        <option value="patrykgoralowski">patrykgoralowski</option>
        <option value="maciejgrabek">maciejgrabek</option>
        <option value="michallusiak">michallusiak</option>
    </select>
    <button id="btn-set-stream">Set Stream</button>
    //TODO: add loading overlay and simplifed notification
    //TODO: get the ip of the requester ? 
    //TODO: we need to send talk id for projection
}

@section scripts {
    <script src="/Scripts/jquery.signalR-1.1.3.min.js"></script>
    <script src="/signalr/hubs"></script>

    <script type="text/javascript">
        $(function() {
            $.connection.hub.logging = true;
            var injectHub = $.connection.injectHub;
            injectHub.client.updateClient = function(stream, streaimInfo) {
                $('#inject-place iframe').attr('src', stream);
                $('#stream-title').html(streaimInfo);
            };

            $.connection.hub.start().done(function() {
                $('#btn-set-stream').click(function() {
                    var newStream = $('#new-stream').val();
                    if (newStream.includes("watch?v=")) {
                        newStream = newStream.replace("watch?v=", "embed/");
                    }
                    injectHub.server.updateStream(newStream, $('#password').val(), $('#selected-stream').val());
                    $.post("@Url.Action("UpdateStream")",
                        {
                            newStream: newStream,
                            password: $('#password').val(),
                            streamType: $('#selected-stream').val()
                        });
                });

            });

            $('.vote-div').click(function () {
                var type = $(this).attr("id");
                $.post("@Url.Action("Vote")",
                    {
                        votetype: type,
                        talkId: 1,
                        comment: $('#vote-comment').val()
                    });
            });

            $.connection.hub.disconnected(function() {
                setTimeout(function() {
                    $.connection.hub.start();
                }, 10000);
            });
        });
    </script>
}